# Enable mod_rewrite
RewriteEngine On

# Redirect all requests to the Next.js application
RewriteCond %{REQUEST_URI} !^/_next/
RewriteCond %{REQUEST_URI} !^/static/
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.*)$ http://localhost:3008/$1 [P,L]

# Handle Next.js static files and API routes
RewriteRule ^(_next|static|api)/(.*)$ http://localhost:3008/$1/$2 [P,L]

# Reverse proxy to http://localhost:3008 for the main domain
RewriteCond %{REQUEST_URI} !^/backend
RewriteRule ^(.*)$ http://localhost:3008/$1 [P,L]

# Reverse proxy to http://localhost:3007 for /backend path
RewriteCond %{REQUEST_URI} ^/backend
RewriteRule ^/backend(.*)$ http://localhost:3007/$1 [P,L]

# Allow proxying requests
RewriteCond %{HTTP:X-Forwarded-Proto} https
RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s